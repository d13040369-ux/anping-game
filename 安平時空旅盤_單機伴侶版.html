<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®‰å¹³æ—…ç›¤ - å€‹äººä¼´ä¾¶ (AI é¡§å•ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;700;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        anping: { 
                            blue: '#265463',
                            red: '#B93A28',
                            gold: '#D4AF37',
                            bg: '#F8F9FA'
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F2F5; -webkit-tap-highlight-color: transparent; }
        .card-flip-inner { transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .card-flip-inner.flipped { transform: rotateY(180deg); }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .color-red { border-color: #EF4444; }
        .color-blue { border-color: #3B82F6; }
        .color-green { border-color: #10B981; }
        .color-yellow { border-color: #F59E0B; }
        
        .bg-red-theme { background-color: #EF4444; }
        .bg-blue-theme { background-color: #3B82F6; }
        .bg-green-theme { background-color: #10B981; }
        .bg-yellow-theme { background-color: #F59E0B; }

        .img-upload-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px;
            font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.3s; font-weight: bold;
        }
        .group:active .img-upload-hint { opacity: 1; }

        .ai-thinking {
            display: inline-block;
            animation: pulse-ai 1.5s infinite;
        }
        @keyframes pulse-ai {
            0% { opacity: 0.5; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.5; transform: scale(0.95); }
        }

        @keyframes victory-pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .victory-anim { animation: victory-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* AI Chat Bubble Style */
        .ai-bubble {
            position: relative;
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            color: #0C4A6E;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .ai-bubble::before {
            content: 'ğŸ¤– æ´‹è¡Œé¡§å•';
            display: block;
            font-size: 10px;
            font-weight: bold;
            color: #0284C7;
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- æª”æ¡ˆä¸Šå‚³å…ƒä»¶ -->
    <input type="file" id="file-uploader" accept="image/*" style="display: none;">

    <!-- 1. è§’è‰²é¸æ“‡ç•«é¢ -->
    <div id="screen-setup" class="flex-1 flex flex-col items-center justify-center p-6 bg-slate-900 text-white z-50 absolute inset-0">
        <div class="text-7xl mb-6">ğŸ¦</div>
        <h1 class="text-4xl font-serif font-bold mb-2 tracking-wide text-center text-anping-gold">å®‰å¹³æ™‚ç©ºæ—…ç›¤</h1>
        <p class="text-sm opacity-60 mb-10 tracking-widest text-center">AI æ•¸ä½ä¼´ä¾¶ (åˆå§‹é«”åŠ›ï¼š0)</p>
        
        <div class="w-full max-w-xs space-y-8">
            <div class="text-center">
                <label class="text-xs opacity-50 mb-6 block uppercase tracking-widest font-bold">è«‹é»æ“Šé¸æ“‡ä»£è¡¨è‰²é–‹å§‹</label>
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="app.startGame('red')" class="group flex flex-col items-center gap-3">
                        <div class="w-20 h-20 rounded-3xl bg-red-500 shadow-xl group-active:scale-90 transition flex items-center justify-center text-3xl shadow-red-500/20">ğŸš©</div>
                        <span class="text-xs font-bold opacity-80">ç«ç´…èµ¤ç…</span>
                    </button>
                    <button onclick="app.startGame('blue')" class="group flex flex-col items-center gap-3">
                        <div class="w-20 h-20 rounded-3xl bg-blue-500 shadow-xl group-active:scale-90 transition flex items-center justify-center text-3xl shadow-blue-500/20">âš“</div>
                        <span class="text-xs font-bold opacity-80">æ´‹è¡Œé›ç…</span>
                    </button>
                    <button onclick="app.startGame('green')" class="group flex flex-col items-center gap-3">
                        <div class="w-20 h-20 rounded-3xl bg-green-500 shadow-xl group-active:scale-90 transition flex items-center justify-center text-3xl shadow-green-500/20">ğŸŒ³</div>
                        <span class="text-xs font-bold opacity-80">æ—è”­é’ç…</span>
                    </button>
                    <button onclick="app.startGame('yellow')" class="group flex flex-col items-center gap-3">
                        <div class="w-20 h-20 rounded-3xl bg-yellow-500 shadow-xl group-active:scale-90 transition flex items-center justify-center text-3xl shadow-yellow-500/20">ğŸ’°</div>
                        <span class="text-xs font-bold opacity-80">é–ƒè€€é‡‘ç…</span>
                    </button>
                </div>
            </div>
            
            <button onclick="app.showCheckList()" class="w-full py-3 bg-white/10 border border-white/20 rounded-xl text-sm font-bold hover:bg-white/20 transition flex items-center justify-center gap-2">
                <span>ğŸ“</span> æŸ¥çœ‹åœ–ç‰‡æª”åå°ç…§è¡¨
            </button>
        </div>
    </div>

    <!-- åœ–ç‰‡æª¢æŸ¥ Modal -->
    <div id="modal-checklist" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl h-3/4 flex flex-col">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex justify-between items-center">
                <span>ğŸ“ åœ–ç‰‡æª”åå°ç…§</span>
                <button onclick="document.getElementById('modal-checklist').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </h3>
            <div class="flex-1 overflow-y-auto space-y-2 pr-2 text-sm" id="checklist-content"></div>
            <div class="mt-4 pt-4 border-t text-xs text-gray-400 text-center">
                è«‹ç¢ºä¿åœ–ç‰‡å‰¯æª”åç‚ºå°å¯« .jpg
            </div>
        </div>
    </div>

    <!-- 2. éŠæˆ²ä¸»ç•«é¢ -->
    <div id="screen-game" class="hidden flex flex-col h-full bg-gray-100">
        <header class="bg-white shadow-sm z-10 shrink-0">
            <div class="px-4 py-2 flex justify-between items-center border-b border-gray-100 bg-gray-50/50">
                <div class="flex items-center gap-2">
                    <span id="player-icon" class="text-2xl">ğŸ¦</span>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Asset Balance</span>
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-gray-500">å¸‚å ´èŒ¶åƒ¹:</span>
                            <span id="hud-market-price" class="text-lg font-black text-anping-red">$50</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <span id="hud-round" class="text-[10px] text-gray-400 font-bold block">Round 1</span>
                    <div class="flex gap-2 justify-end mt-1">
                        <button onclick="actions.openSaveModal()" class="text-[10px] bg-white text-gray-600 px-2 py-0.5 rounded border border-gray-200">å­˜æª”/è¼‰å…¥</button>
                        <button onclick="app.resetGame()" class="text-[10px] text-gray-400">é‡ç½®</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-4 divide-x divide-gray-100 bg-white">
                <div class="p-2 text-center">
                    <div class="text-[10px] text-gray-400 mb-1 font-bold">ç¾é‡‘</div>
                    <div id="stat-money" class="font-bold text-anping-blue text-sm">--</div>
                </div>
                <div class="p-2 text-center">
                    <div class="text-[10px] text-gray-400 mb-1 font-bold">é«”åŠ›</div>
                    <div id="stat-energy" class="font-bold text-green-600 text-sm">--</div>
                </div>
                <div class="p-2 text-center">
                    <div class="text-[10px] text-gray-400 mb-1 font-bold">åº«å­˜</div>
                    <div id="stat-stock" class="font-bold text-gray-800 text-sm">--</div>
                </div>
                <div class="p-2 text-center bg-purple-50">
                    <div class="text-[10px] text-purple-400 mb-1 font-bold">åŠç…</div>
                    <div id="stat-lions" class="font-bold text-purple-600 text-sm">0/3</div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden p-4 flex flex-col relative" id="main-area">
            
            <div id="view-idle" class="flex-1 flex flex-col items-center justify-center text-center transition-opacity duration-300">
                <div id="avatar-ring" class="mb-10 p-10 bg-white rounded-full shadow-2xl w-56 h-56 flex items-center justify-center border-8 relative transition-colors duration-500">
                    <span id="dice-result" class="text-8xl relative z-10">ğŸ²</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2 tracking-tight">è«‹åœ¨å¯¦é«”æ£‹ç›¤æ“²éª°</h2>
                <p id="location-hint" class="text-gray-400 mb-12 px-4 text-sm font-medium">ç›®å‰ä½ç½®: èµ·é» GO</p>
                <button id="btn-roll-main" onclick="game.rollDice()" class="w-full max-w-xs py-5 text-white rounded-3xl shadow-xl font-bold text-2xl transition transform active:scale-95 flex items-center justify-center gap-3 bg-slate-900">
                    <span>ğŸ² æ“²éª°å­è¡Œå‹•</span>
                </button>
            </div>

            <div id="view-event" class="hidden flex-1 flex flex-col bg-white rounded-[2.5rem] shadow-2xl overflow-hidden h-full border border-gray-100 animate-in fade-in slide-in-from-bottom-8 duration-500"></div>
        </main>
    </div>

    <!-- 3. Victory Modal -->
    <div id="victory-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-md">
        <div class="relative bg-white rounded-[3rem] p-10 w-full max-w-sm text-center shadow-2xl border-4 border-anping-gold victory-anim overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-red-500 via-anping-gold to-blue-500"></div>
            <div class="text-7xl mb-6">ğŸ†</div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">å®‰å¹³æ™‚ç©ºå®ˆè­·è€…</h2>
            <p class="text-slate-500 mb-8 font-medium">æ‚¨å·²é”æˆå‹åˆ©æ¢ä»¶ï¼Œå®ˆè­·äº†å¤åŸçš„æ¦®è€€ï¼</p>
            <div class="bg-amber-50 p-6 rounded-3xl border-2 border-dashed border-anping-gold mb-8 transform rotate-1 shadow-inner relative overflow-hidden">
                <p class="text-[10px] text-amber-700 font-bold uppercase tracking-widest mb-2">âœ¨ éš±è—å½©è›‹è§£é– âœ¨</p>
                <p class="text-sm text-amber-900 mb-3 font-bold">è§£é–æˆå°±ä»£ç¢¼ï¼š</p>
                <p class="text-3xl font-mono text-anping-red font-black" id="egg-code">HERO-ANPING</p>
                <p class="text-[9px] text-amber-600 mt-2 tracking-tighter">ï¼ˆé•·æŒ‰ä»£ç¢¼å¯è¤‡è£½ï¼Œè§£é– App éš±è—ç¨±è™Ÿï¼‰</p>
            </div>
            <button onclick="location.reload()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold">å†æ¬¡å›åˆ°éå»</button>
        </div>
    </div>

    <!-- Save/Load Modal -->
    <div id="save-load-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold text-anping-blue mb-6">é€²åº¦å­˜å–</h2>
            <div class="space-y-6">
                <div class="p-6 border border-gray-100 rounded-3xl text-center bg-gray-50">
                    <div id="qrcode-container" class="w-48 h-48 mx-auto mb-4 p-2 bg-white rounded-2xl flex items-center justify-center"></div>
                    <p class="text-[10px] text-gray-400 font-bold">æƒæäºŒç¶­ç¢¼ä¿å­˜é€²åº¦</p>
                </div>
                <textarea id="load-code-input" placeholder="è²¼ä¸Šä»£ç¢¼..." rows="3" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl text-xs outline-none"></textarea>
                <button onclick="actions.loadGame()" class="w-full py-4 bg-anping-gold text-white rounded-2xl font-bold shadow-lg">è¼‰å…¥é€²åº¦</button>
            </div>
            <button onclick="ui.closeModal('save-load-modal')" class="w-full mt-6 py-3 text-gray-400 font-bold">é—œé–‰</button>
        </div>
    </div>

    <!-- Templates -->
    <template id="tmpl-trade">
        <div class="flex flex-col h-full">
            <div class="relative h-64 shrink-0 overflow-hidden bg-slate-200 group" onclick="game.triggerImgUpload()">
                <img id="evt-img" src="" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.src='https://placehold.co/800x600/2D6E7E/FFFFFF?text=Click+To+Add+Photo'">
                <div class="img-upload-hint">é»æ“Šæ›´æ›ç…§ç‰‡</div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/30 to-transparent pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full p-6 pointer-events-none">
                    <div class="flex items-center gap-2 mb-2">
                        <span id="evt-cat" class="text-[10px] font-bold bg-white/20 text-white px-2 py-0.5 rounded backdrop-blur-sm border border-white/10 uppercase tracking-widest">æ­·å²æ™¯é»</span>
                    </div>
                    <h3 id="evt-title" class="text-white font-serif font-bold text-3xl drop-shadow-xl">åœ°é»åç¨±</h3>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar bg-white p-6">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Landmark Guide</h4>
                        <button onclick="actions.askAiStory(event)" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-200 font-bold hover:bg-indigo-100 flex items-center gap-1 transition">
                            <span>âœ¨</span> è½è½ AI è¬›å¤
                        </button>
                    </div>
                    <p id="evt-intro" class="text-sm text-slate-600 leading-relaxed text-justify font-medium"></p>
                    <div id="ai-response-area"></div>
                </div>
                <div id="market-section" class="space-y-8">
                    <div>
                        <div class="flex justify-between items-end mb-3">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Market Trend</span>
                            <div class="flex justify-between w-full items-center gap-2">
                                <div class="flex items-baseline gap-1">
                                    <span class="text-xs text-gray-500">ç•¶å‰èŒ¶åƒ¹</span>
                                    <span id="evt-price" class="font-black text-2xl text-anping-red">$0</span>
                                </div>
                                <button onclick="actions.askAiInvestment(event)" class="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded border border-emerald-200 font-bold hover:bg-emerald-100 flex items-center gap-1 transition">
                                    <span>ğŸ“Š</span> AI æŠ•è³‡å»ºè­°
                                </button>
                            </div>
                        </div>
                        <div class="h-32 bg-gray-50 rounded-2xl border border-gray-100 p-2 shadow-inner"><canvas id="tradeChart"></canvas></div>
                        <div class="flex items-center justify-between mt-3 bg-slate-50 p-2 rounded-xl border border-slate-100">
                             <button onclick="actions.adjustAmount(-1)" class="w-8 h-8 rounded-lg bg-white shadow-sm border border-slate-200 font-bold text-slate-600">-</button>
                             <span class="text-xs font-bold text-slate-500">QTY: <span id="trade-amount-display" class="text-base text-slate-800 ml-1">1</span></span>
                             <button onclick="actions.adjustAmount(1)" class="w-8 h-8 rounded-lg bg-anping-blue text-white shadow-sm font-bold">+</button>
                        </div>
                        <div id="ai-invest-area"></div>
                    </div>
                    <div id="section-lion" class="hidden">
                        <button onclick="actions.searchLion()" class="w-full py-5 bg-gradient-to-br from-purple-600 to-indigo-800 text-white rounded-2xl font-bold shadow-xl flex items-center justify-center gap-4 active:scale-95 transition">
                            <span class="text-3xl">ğŸ¦</span> 
                            <div class="flex flex-col items-start leading-none text-left">
                                <span class="text-base mb-1">æ¢ç´¢éš±è—åŠç…</span>
                                <span class="text-[10px] opacity-70 uppercase tracking-widest">æ¶ˆè€— 15 é«”åŠ›</span>
                            </div>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 pb-8" id="trade-actions">
                        <button onclick="actions.trade('buy')" class="py-5 bg-anping-blue text-white rounded-2xl font-bold shadow-xl active:scale-95 transition">è²·å…¥èŒ¶è‘‰</button>
                        <button onclick="actions.trade('sell')" class="py-5 bg-white border-2 border-anping-blue text-anping-blue rounded-2xl font-bold shadow-md active:scale-95 transition">è³£å‡ºç²åˆ©</button>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-gray-100 bg-gray-50 shrink-0"><button onclick="game.endTurn()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl transition active:scale-95">å®Œæˆè¡Œå‹•</button></div>
        </div>
    </template>

    <template id="tmpl-food">
        <div class="flex flex-col h-full">
            <div class="relative h-64 shrink-0 overflow-hidden bg-slate-200 group" onclick="game.triggerImgUpload()">
                <img id="food-img" src="" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.src='https://placehold.co/800x600/B93A28/FFFFFF?text=Click+To+Add+Photo'">
                <div class="img-upload-hint">æ›´æ›åœ–ç‰‡</div>
                <div class="absolute inset-0 bg-gradient-to-t from-anping-red/90 to-transparent pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full p-6 pointer-events-none">
                    <h3 id="food-title" class="text-4xl font-serif font-bold text-white mb-2 relative z-10 tracking-tight">åºœåŸç¾é£Ÿ</h3>
                </div>
            </div>
            <div class="p-6 bg-white border-b border-gray-100">
                 <div class="flex justify-between items-center mb-2">
                    <p id="food-desc" class="text-sm text-gray-600 leading-relaxed"></p>
                    <button onclick="actions.askAiFoodReview(event)" class="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded border border-orange-200 font-bold hover:bg-orange-100 flex items-center gap-1 transition shrink-0 ml-2">
                        <span>ğŸ˜‹</span> AI é£Ÿè©•
                    </button>
                 </div>
                 <div id="ai-food-area"></div>
            </div>
            <div id="food-list" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50 no-scrollbar"></div>
            <div class="p-6 border-t border-gray-100 bg-white shrink-0">
                <button onclick="game.endTurn()" class="w-full py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl">é›¢é–‹é¤å»³</button>
            </div>
        </div>
    </template>

    <template id="tmpl-card">
        <div class="flex flex-col h-full items-center justify-center p-10 bg-gray-50 relative overflow-hidden">
            <div id="card-pattern" class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#C14A36 1px, transparent 1px); background-size: 24px 24px;"></div>
            <h3 id="card-type" class="text-4xl font-black text-gray-200 mb-12 tracking-[1rem] uppercase relative z-10">EVENT</h3>
            <div class="perspective-1000 cursor-pointer w-64 h-96 relative z-10" onclick="actions.flipCard()">
                <div id="card-inner" class="card-flip-inner relative w-full h-full shadow-2xl transition-transform duration-700">
                    <div id="card-front" class="absolute inset-0 rounded-[2.5rem] backface-hidden flex flex-col items-center justify-center border-[14px] border-white shadow-inner"><span class="text-9xl text-white">â“</span></div>
                    <div class="absolute inset-0 bg-white rounded-[2.5rem] backface-hidden rotate-y-180 flex flex-col items-center justify-center p-10 text-center border-[14px] border-gray-100 shadow-inner">
                        <div id="card-icon" class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center text-4xl mb-6 shadow-inner">âœ¨</div>
                        <h4 id="card-content-title" class="text-2xl font-black mb-4 text-gray-800 tracking-wider">...</h4>
                        <p id="card-content-desc" class="text-sm text-slate-500 leading-relaxed font-medium"></p>
                    </div>
                </div>
            </div>
            <button id="btn-card-done" onclick="game.endTurn()" class="absolute bottom-10 left-10 right-10 py-5 bg-slate-900 text-white rounded-3xl font-bold shadow-2xl opacity-0 pointer-events-none transition-all transform translate-y-10 z-20">ç¢ºèªé ˜å–</button>
        </div>
    </template>

    <script>
        // --- Gemini API Key (Direct Injection) ---
        // è«‹å°‡æ‚¨çš„ Key æ›¿æ›æ­¤è™•çš„ç©ºå­—ä¸²
        const apiKey = "AIzaSyDn3ZtZuHZXVIybbKQ5eov0CErZ_VqyoZw"; 

        // --- 1. Map Data ---
        const mapData = [
            { id: 0, type: 'start', name: "èµ·é» GO", intro: "å®‰å¹³æ—…ç¨‹çš„æºåœ°ã€‚æ¯æ¬¡ç¶“éæ­¤è™•ï¼Œé ˜å– $300 è£œçµ¦é‡‘èˆ‡æ¢å¾© 10 é»é«”åŠ›ã€‚æ‚¨æ­£ç«™åœ¨å°ç£æ­·å²çš„å…¥å£ï¼Œæ·±å¸ä¸€å£æµ·é¢¨ï¼Œå‡ºç™¼å§ï¼" },
            { id: 1, type: 'food', name: "é˜¿è²¡ç‰›è‚‰æ¹¯", menu: [{n:"æº«é«”ç‰›è‚‰æ¹¯",p:120,e:30},{n:"è‚‰ç‡¥é£¯",p:40,e:10},{n:"è”¥çˆ†ç‰›",p:180,e:40}], desc: "å°å—äººçš„æ´»åŠ›èµ·é»ï¼æ¯æ—¥ç¾å®°æº«é«”ç‰›ï¼Œæ¹¯é ­é®®ç”œå›ç”˜ï¼Œæ˜¯ä¸€å¤©æ¢ç´¢å‹•åŠ›çš„é—œéµã€‚", img: "1.jpg" },
            { id: 2, type: 'trade', cat: "æ–‡å‰µ", name: "åŠç…ä¸»é¡Œå°å··", intro: "éš±èº«åœ¨å®‰å¹³å··å¼„ä¸­çš„é©šå–œã€‚é€™è£¡ä¿ç•™äº†è¨±å¤šå‚³çµ±æ°‘å®…ï¼Œé–€æ¥£ä¸Šå„å¼çš„åŠç…è¡¨æƒ…å„ç•°ï¼Œæ˜¯å®‰å¹³æœ€å…·ç‰¹è‰²çš„å¸¸æ°‘æ–‡åŒ–æ™¯è‡´ã€‚", img: "2.jpg" },
            { id: 3, type: 'trade', cat: "é˜²ç¦¦", name: "å®‰å¹³å°ç ²å°", intro: "èˆˆå»ºæ–¼æ¸…é“å…‰å¹´é–“ï¼Œæ˜¯é´‰ç‰‡æˆ°çˆ­æ™‚æœŸé˜²ç¦¦è‹±è»å…¥ä¾µçš„é‡è¦æµ·é˜²å ¡å£˜ã€‚ç ²å°åŸºåº§è‡³ä»Šç©©å›ºï¼Œè¦‹è­‰äº†æµ·é˜²æ­·å²ã€‚", img: "3.jpg" }, 
            { id: 4, type: 'food', name: "å‘¨æ°è¦æ²", menu: [{n:"ç‚¸è¦æ²",p:70,e:20},{n:"æµ·é®®æ´¾",p:70,e:20},{n:"é­šä¸¸æ¹¯",p:40,e:10}], desc: "åœ‹å®´ç´šç¾é£Ÿï¼é®®ç”œç«ç‡’è¦è£¹ä¸Šç‰¹è£½ç²‰æ¼¿æ²¹ç‚¸ï¼Œå¤–é…¥å…§å«©ã€‚é«”åŠ›æ¢å¾©ç¥é€Ÿã€‚", img: "4.jpg" },
            { id: 5, type: 'chance', name: "æ©Ÿæœƒ" },
            { id: 6, type: 'trade', cat: "æ­¥é“", name: "é‹æ²³è§€æ™¯æ­¥é“", intro: "æ²¿è‘—æ­·å²æ‚ ä¹…çš„å®‰å¹³é‹æ²³æ¼«æ­¥ï¼Œæ¨¹å½±å©†å¨‘ã€‚å¤œæ™šæ›´æœ‰ç‡ˆå…‰é»ç¶´ï¼Œæ˜¯å°å—æœ€ç¾çš„è¦ªæ°´å»Šé“ã€‚é€™è£¡ä¹Ÿæ˜¯éå»èŒ¶è‘‰å‡ºå£çš„é‡è¦èˆªé“ã€‚", img: "6.jpg" },
            { id: 7, type: 'trade', cat: "æ–‡å²", name: "å¾·è¨˜æ´‹è¡Œ", intro: "1867å¹´å»ºç«‹çš„ç´”ç™½è¿´å»Šå¼å»ºç¯‰ï¼Œè¦‹è­‰å®‰å¹³é–‹æ¸¯å¾Œçš„é»ƒé‡‘è²¿æ˜“æ­²æœˆã€‚ç¾ç´€éŒ„å¤§èˆªæµ·æ™‚ä»£çš„è²¿æ˜“æ­·å²ã€‚", relic: "lion1", img: "7.jpg" },
            { id: 8, type: 'trade', cat: "å®—æ•™", name: "å®‰å¹³é–‹å°å¤©åå®®", intro: "å®‰å¹³äººçš„ä¿¡ä»°æ ¸å¿ƒï¼Œä¾›å¥‰éš¨è»ä¾†å°åª½ç¥–åƒã€‚å»ºç¯‰ç²¾æ¹›ï¼Œå®ˆè­·æ¸¯å£å­æ°‘å®‰å…¨ã€‚", img: "8.jpg" },
            { id: 9, type: 'trade', cat: "æ­·å²", name: "å®‰å¹³å¤å ¡", intro: "å°ç£ç¬¬ä¸€åº§åŸå ¡(ç†±è˜­é®åŸ)ï¼Œè·è˜­äººæ–¼1624å¹´å»ºé€ ï¼Œæ˜¯æ­·å²èµ·é»ã€‚", relic: "lion2", img: "9.jpg" },
            { id: 10, type: 'corner', name: "æ—é»˜å¨˜å…¬åœ’", intro: "æ”¾é¢¨ç®ã€çœ‹å¤•é™½çš„è–åœ°ã€‚åœç•™æ­¤è™•å¯æ¢å¾© 5 é»é«”åŠ›ã€‚", img: "10.jpg" },
            { id: 11, type: 'food', name: "é™³å®¶èšµæ²", menu: [{n:"èšµä»”ç…",p:80,e:25},{n:"èšµæ²",p:70,e:20},{n:"è™±ç›®é­šä¸¸æ¹¯",p:40,e:10}], desc: "å‰èšµä¸–å®¶ç›´ç‡Ÿï¼æ–°é®®æ»¿åˆ†ã€‚æ¯ä¸€å£éƒ½æ˜¯æ»¿æ»¿çš„å®‰å¹³é®®å‘³ã€‚", img: "11.jpg" },
            { id: 12, type: 'trade', cat: "ç”Ÿæ…‹", name: "å°æ±Ÿç”Ÿæ…‹ä¸­å¿ƒ", intro: "å…¨å°å”¯ä¸€é«˜è…³å±‹è¨­è¨ˆï¼Œæµ®æ–¼æ¿•åœ°ä¹‹ä¸Šï¼Œæ˜¯èªè­˜æ½Ÿæ¹–ã€ç´…æ¨¹æ—èˆ‡é»‘é¢çµé·ºçš„æœ€ä½³å ´åŸŸã€‚", img: "12.jpg" },
            { id: 13, type: 'trade', cat: "è‡ªç„¶", name: "å››è‰ç¶ è‰²éš§é“", intro: "å°ç‰ˆäºé¦¬éœã€‚ç´…æ¨¹æ—äº¤ç¹”å½¢æˆå¤©ç„¶ç¶ è‰²æ‹±é–€ï¼Œæ­ä¹˜ç«¹ç­ç©¿æ¢­å…¶ä¸­æ™¯è§€å¤¢å¹»è¿·äººã€‚", relic: "lion3", img: "13.jpg" },
            { id: 14, type: 'trade', cat: "æµ·æ™¯", name: "å®‰å¹³æµ·æ¸¯", intro: "è§€å¤•å¹³å°å‘¨é‚Šï¼Œæ›¾æ˜¯ç¹ç››çš„é€šå•†æ¸¯å£ï¼Œç¾ç‚ºæµªæ¼«è§€æµªå‹åœ°ã€‚ç´°å¿ƒæ¢ç´¢æµ·ç˜ï¼Œæˆ–è¨±æœ‰æ„å¤–ç™¼ç¾ã€‚", img: "14.jpg" },
            { id: 15, type: 'destiny', name: "å‘½é‹" },
            { id: 16, type: 'trade', cat: "äº¤é€š", name: "å››è‰å¤§æ©‹", intro: "æ©«è·¨é¹½æ°´æºªé€£æ¥å››è‰ï¼Œè¦–é‡æ¥µä½³ã€‚æä¾›å¿«é€Ÿé€šé—œæœå‹™ï¼Œä½†éœ€æ”¯ä»˜éè·¯è²»ã€‚", img: "16.jpg" },
            { id: 17, type: 'trade', cat: "å¤å»Ÿ", name: "è§€éŸ³äº­", intro: "ç’°å¢ƒæ¸…å¹½å¤æ¨¸ï¼Œæ˜¯ç•¶åœ°äººå°‹æ±‚å¿ƒéˆå¹³éœçš„é‡è¦å ´æ‰€ã€‚", img: "17.jpg" },
            { id: 18, type: 'trade', cat: "æ–‡åŒ–", name: "å®‰å¹³èšµç°çª¯", intro: "å°ç£åƒ…å­˜çš„å®Œæ•´èšµç°çª¯ï¼Œè¦‹è­‰äº†å®‰å¹³å‚³çµ±ç”¢æ¥­çš„æ­·å²ã€‚èšµç°æ˜¯æ—©æœŸå»ºç¯‰çš„é‡è¦é»è‘—åŠ‘ï¼Œç‡’è£½éç¨‹è²»æ™‚è²»å·¥ã€‚", img: "18.jpg" },
            { id: 19, type: 'trade', cat: "è—è¡“", name: "å¤§é­šçš„ç¥ç¦", intro: "æ¥Šå£«æ¯…è¨­è¨ˆã€‚é¯¨é­šé€ å‹è±¡å¾µå°ç£çš„åŒ…å®¹èˆ‡æ„›ï¼Œå…§éƒ¨è£æœ‰å½©ç¹ªç»ç’ƒï¼Œç•¶å…‰ç·šç©¿éæ™‚è‰²å½©æ–‘æ–•ã€‚", img: "19.jpg" }
        ];

        // --- 2. State & Engine ---
        let player = { money: 1000, energy: 0, stock: 0, pos: 0, lions: [], round: 1, color: 'red' };
        let market = { price: 50, history: [50, 48, 55, 52, 50, 58, 45, 50] };
        let tradeAmount = 1;
        let customImages = JSON.parse(localStorage.getItem('customImages')) || {};
        let pendingImgUploadId = null;

        // --- 3. Gemini Helper ---
        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("AI Error:", error);
                return null;
            }
        }

        const app = {
            startGame: (color) => {
                player.color = color;
                const ring = document.getElementById('avatar-ring');
                const btn = document.getElementById('btn-roll-main');
                const themes = { red: 'border-red-500 bg-red-400', blue: 'border-blue-500 bg-blue-400', green: 'border-green-500 bg-green-400', yellow: 'border-yellow-500 bg-yellow-400' };
                const icons = { red: 'ğŸš©', blue: 'âš“', green: 'ğŸŒ³', yellow: 'ğŸ’°' };
                
                if(ring) ring.className = `mb-10 p-10 bg-white rounded-full shadow-2xl w-56 h-56 flex items-center justify-center border-8 ${themes[color].border} relative transition-colors duration-500`;
                if(btn) btn.className = `w-full max-w-xs py-5 text-white rounded-3xl shadow-xl font-bold text-2xl transition transform active:scale-95 flex items-center justify-center gap-3 bg-slate-900`;
                document.getElementById('player-icon').innerText = icons[color];
                
                // Init uploader
                const uploader = document.getElementById('file-uploader');
                if(uploader) {
                    uploader.onchange = (e) => {
                        const file = e.target.files[0];
                        if(file && pendingImgUploadId !== null) {
                            const reader = new FileReader();
                            reader.onload = (re) => {
                                const dataUrl = re.target.result;
                                customImages[pendingImgUploadId] = dataUrl;
                                localStorage.setItem('customImages', JSON.stringify(customImages));
                                
                                const imgEl = document.getElementById('evt-img') || document.getElementById('food-img');
                                if(imgEl) imgEl.src = dataUrl;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                }

                document.getElementById('screen-setup').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                app.updateUI();
            },
            updateUI: () => {
                document.getElementById('stat-money').innerText = `$${player.money}`;
                document.getElementById('stat-energy').innerText = player.energy;
                document.getElementById('stat-stock').innerText = player.stock;
                document.getElementById('stat-lions').innerText = `${player.lions.length}/3`;
                document.getElementById('hud-market-price').innerText = `$${market.price}`;
                document.getElementById('hud-round').innerText = `Round ${player.round}`;
                document.getElementById('location-hint').innerText = `ç›®å‰ä½ç½®: ${mapData[player.pos].name}`;
            },
            resetGame: () => { 
                if(confirm("ç¢ºå®šé‡ç½®å—ï¼Ÿ")) { 
                    localStorage.removeItem('customImages'); 
                    location.reload(); 
                } 
            },
            showCheckList: () => {
                const list = document.getElementById('checklist-content');
                list.innerHTML = mapData.filter(t => t.img).map(t => 
                    `<div class="flex justify-between border-b border-gray-100 py-2">
                        <span class="font-medium text-slate-700">${t.name}</span>
                        <span class="font-mono text-anping-blue bg-blue-50 px-2 rounded">${t.id}.jpg</span>
                    </div>`
                ).join('');
                document.getElementById('modal-checklist').classList.remove('hidden');
            }
        };

        const game = {
            triggerImgUpload: () => {
                const tile = mapData[player.pos];
                if(!tile.img) return;
                pendingImgUploadId = tile.id;
                document.getElementById('file-uploader').click();
            },
            rollDice: async () => {
                const dice = document.getElementById('dice-result');
                const btn = document.getElementById('btn-roll-main');
                btn.disabled = true; btn.classList.add('opacity-50'); dice.classList.add('animate-spin');
                await new Promise(r => setTimeout(r, 600));
                dice.classList.remove('animate-spin');
                const steps = Math.floor(Math.random() * 6) + 1; dice.innerText = steps;
                let newPos = (player.pos + steps) % mapData.length;
                if (newPos < player.pos) { player.money += 300; player.energy += 10; alert("ğŸ”„ ç¶“éèµ·é»ï¼é ˜å–è£œçµ¦é‡‘ $300 èˆ‡ æ¢å¾© 10 é«”åŠ›ã€‚"); }
                player.pos = newPos; app.updateUI();
                setTimeout(() => { game.showEvent(newPos); btn.disabled = false; btn.classList.remove('opacity-50'); }, 500);
            },
            showEvent: (pos) => {
                document.getElementById('view-idle').classList.add('hidden');
                const stage = document.getElementById('view-event');
                stage.classList.remove('hidden'); stage.innerHTML = '';
                const tile = mapData[pos];
                let tmplId = tile.type === 'food' ? 'tmpl-food' : (tile.type === 'chance' || tile.type === 'destiny' ? 'tmpl-card' : 'tmpl-trade');
                const template = document.getElementById(tmplId);
                if(!template) return;
                const content = template.content.cloneNode(true);
                
                const imgSrc = customImages[tile.id] || tile.img || "";

                if (tmplId === 'tmpl-trade') {
                    content.querySelector('#evt-title').innerText = tile.name;
                    content.querySelector('#evt-intro').innerText = tile.intro;
                    content.querySelector('#evt-img').src = imgSrc;
                    content.querySelector('#evt-price').innerText = `$${market.price}`;
                    
                    tradeAmount = 1;
                    content.querySelector('#trade-amount-display').innerText = tradeAmount;

                    if (tile.type !== 'trade') { 
                        content.querySelector('#trade-actions')?.classList.add('hidden'); 
                        content.querySelector('#market-section')?.classList.add('hidden'); 
                    } else {
                        setTimeout(() => {
                            const ctx = document.getElementById('tradeChart');
                            if(ctx) new Chart(ctx.getContext('2d'), { type: 'line', data: { labels: market.history.map((_,i)=>i), datasets: [{ data: market.history, borderColor: '#2D6E7E', tension: 0.3, pointRadius: 0, borderWidth: 3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: {legend:false}, scales: {x:{display:false}, y:{display:false}} } });
                        }, 100);
                    }
                    if (tile.relic && !player.lions.includes(tile.relic.id)) content.querySelector('#section-lion')?.classList.remove('hidden');
                } else if (tmplId === 'tmpl-food') {
                    content.querySelector('#food-title').innerText = tile.name;
                    content.querySelector('#food-desc').innerText = tile.desc;
                    content.querySelector('#food-img').src = imgSrc;
                    tile.menu.forEach(m => {
                        const item = document.createElement('button');
                        item.className = "w-full flex justify-between items-center p-4 bg-slate-50 border border-slate-100 rounded-xl active:scale-[0.98] transition hover:bg-slate-100";
                        item.innerHTML = `<div><div class="font-bold text-slate-800">${m.n}</div><div class="text-xs text-green-600 font-bold">+${m.e} é«”åŠ›</div></div><div class="text-lg font-black text-anping-red">$${m.p}</div>`;
                        item.onclick = () => actions.eat(m.p, m.e);
                        content.querySelector('#food-list').appendChild(item);
                    });
                } else if (tmplId === 'tmpl-card') {
                    const isDestiny = tile.type === 'destiny';
                    const cardFront = content.querySelector('#card-front');
                    const cardType = content.querySelector('#card-type');
                    if(isDestiny) {
                        cardFront?.classList.add('bg-purple-600');
                        cardType.innerText = "DESTINY";
                        const pattern = content.querySelector('#card-pattern');
                        if(pattern) pattern.style.backgroundImage = 'radial-gradient(#8B5CF6 1px, transparent 1px)';
                    } else {
                        cardFront?.classList.add('bg-yellow-400');
                    }
                }
                stage.appendChild(content);
            },
            endTurn: () => {
                const change = Math.floor(Math.random() * 81) - 40;
                market.price = Math.max(10, market.price + change);
                market.history.push(market.price);
                if(market.history.length > 10) market.history.shift();
                player.round++;
                if (player.money + (player.stock * market.price) >= 3000) game.triggerWin();
                if (player.lions.length >= 3) game.triggerWin();
                document.getElementById('view-idle').classList.remove('hidden');
                document.getElementById('view-event').classList.add('hidden');
                app.updateUI();
            },
            triggerWin: () => {
                const modal = document.getElementById('victory-modal');
                if(modal) modal.classList.remove('hidden');
                const codes = ["LION-888", "ANPING-HERO", "TEA-MASTER", "FORT-GUARD"];
                document.getElementById('egg-code').innerText = codes[Math.floor(Math.random()*codes.length)];
            }
        };

        const actions = {
            askAiStory: async (event) => {
                const tile = mapData[player.pos];
                const btn = event.currentTarget; 
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = `<span class="ai-thinking">ğŸ§ </span> æ€è€ƒä¸­...`;
                
                const prompt = `ä½ æ˜¯å®‰å¹³çš„åœ¨åœ°å°éŠï¼Œè«‹ç”¨ç”Ÿå‹•æœ‰è¶£çš„ç¹é«”ä¸­æ–‡ä»‹ç´¹ã€Œ${tile.name}ã€çš„ä¸€å€‹å†·çŸ¥è­˜æˆ–æ­·å²å°æ•…äº‹ï¼Œ50å­—ä»¥å…§ã€‚`;
                const story = await callGemini(prompt);
                
                const responseText = story || `(AI æ¨¡æ“¬å›æ‡‰) é€™è£¡æ˜¯ ${tile.name}ï¼Œç›¸å‚³åœ¨å¹¾ç™¾å¹´å‰... (è«‹è¨­å®š API Key ä»¥ç²å¾—å®Œæ•´é«”é©—)`;

                const introEl = document.getElementById('evt-intro');
                if (introEl) {
                    introEl.innerHTML = `<span class="text-indigo-600 font-bold">âœ¨ AI å°éŠï¼š</span> ${responseText}`;
                    introEl.parentElement.classList.add('bg-indigo-50', 'border-indigo-100');
                }
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            },
            
            askAiInvestment: async (event) => {
                const btn = event.currentTarget; 
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = `...`;
                
                const prompt = `ä½ æ˜¯19ä¸–ç´€çš„æ´‹è¡Œå¤§ç­ã€‚ç›®å‰èŒ¶è‘‰åƒ¹æ ¼æ­·å²ç‚ºï¼š[${market.history}]ï¼Œç•¶å‰åƒ¹æ ¼ $${market.price}ã€‚è«‹çµ¦å‡ºä¸€å€‹ç°¡çŸ­çš„æŠ•è³‡å»ºè­°ï¼ˆè²·å…¥æˆ–è³£å‡ºï¼‰ï¼Œèªæ°£è¦åƒè€ç·´çš„å•†äººï¼Œ30å­—ä»¥å…§ã€‚`;
                const advice = await callGemini(prompt);
                
                const responseText = advice || "ä¾æˆ‘çœ‹ï¼Œç¾åœ¨å¸‚å ´æ³¢å‹•å¤§ï¼Œé‚„æ˜¯ä¿å®ˆä¸€é»å¥½ã€‚(è«‹è¨­å®š API Key)";

                const area = document.getElementById('ai-invest-area');
                if(area) {
                    area.innerHTML = `<div class="ai-bubble border-emerald-200 bg-emerald-50 text-emerald-800 before:content-['ğŸ“ˆ_æŠ•è³‡é¡§å•'] before:text-emerald-600">${responseText}</div>`;
                }
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            },
            
            askAiFoodReview: async (event) => {
                const tile = mapData[player.pos];
                const btn = event.currentTarget; 
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `...`;
                
                const prompt = `ä½ æ˜¯ç¾é£Ÿè©•è«–å®¶ã€‚è«‹ç”¨ä»¤äººå‚æ¶ä¸‰å°ºçš„èªæ°£ï¼Œç°¡çŸ­é»è©•å®‰å¹³ååº—ã€Œ${tile.name}ã€çš„æ‹›ç‰Œç‰¹è‰²ï¼Œ30å­—ä»¥å…§ã€‚`;
                const review = await callGemini(prompt);
                
                const responseText = review || `é€™å®¶çš„${tile.menu[0].n}ç°¡ç›´æ˜¯äººé–“ç¾å‘³ï¼Œæ¹¯é ­é®®ç”œï¼ï¼ˆè«‹è¨­å®š API Key ä»¥ç²å¾—å®Œæ•´é£Ÿè©•ï¼‰`;

                const area = document.getElementById('ai-food-area');
                if(area) {
                    area.innerHTML = `<div class="ai-bubble border-orange-200 bg-orange-50 text-orange-800 before:content-['ğŸ˜‹_ç¾é£Ÿå®¶'] before:text-orange-600">${responseText}</div>`;
                }
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            },

            adjustAmount: (delta) => {
                tradeAmount = Math.max(1, tradeAmount + delta);
                document.getElementById('trade-amount-display').innerText = tradeAmount;
            },
            trade: (type) => {
                const cost = market.price * tradeAmount;
                if (type === 'buy') { 
                    if(player.money >= cost) { 
                        player.money -= cost; 
                        player.stock += tradeAmount; 
                        alert(`ğŸ’° è²·å…¥ ${tradeAmount} ç®±èŒ¶è‘‰æˆåŠŸã€‚`); 
                    } else alert("ç¾é‡‘ä¸è¶³ï¼"); 
                } else { 
                    if(player.stock >= tradeAmount) { 
                        player.money += cost; 
                        player.stock -= tradeAmount; 
                        alert(`ğŸ’° è³£å‡º ${tradeAmount} ç®±èŒ¶è‘‰ç²åˆ©ã€‚`); 
                    } else alert("åº«å­˜ä¸è¶³ï¼"); 
                }
                app.updateUI();
            },
            eat: (p, e) => { if(player.money >= p) { player.money -= p; player.energy += e; alert("ğŸ˜‹ é£½é¤ï¼æ¢å¾©é«”åŠ›ã€‚"); game.endTurn(); } else alert("éŒ¢ä¸å¤ ï¼"); },
            searchLion: () => {
                if(player.energy >= 15) {
                    player.energy -= 15;
                    const spot = mapData[player.pos];
                    player.lions.push(spot.relic);
                    alert("ğŸ‰ ç™¼ç¾äº†éš±è—åŠç…ï¼");
                    game.endTurn();
                } else alert("é«”åŠ›ä¸è¶³ï¼ˆéœ€ 15 é»ï¼‰");
            },
            flipCard: () => {
                const inner = document.getElementById('card-inner'); if(inner?.classList.contains('flipped')) return; inner?.classList.add('flipped');
                const evs = [{t:"å¹¸é‹ç™¼ç¥¨", d:"ç²å¾— $200", f:()=>player.money+=200, i:"ğŸ’°"},{t:"è€é—†è·‘è·¯", d:"åº«å­˜æå¤± 1", f:()=>player.stock=Math.max(0,player.stock-1), i:"ğŸƒ"},{t:"èŒ¶å» åˆ†ç´…", d:"ç²å¾— $150", f:()=>player.money+=150, i:"ğŸ“ˆ"}];
                const ev = evs[Math.floor(Math.random()*evs.length)];
                setTimeout(() => {
                    document.getElementById('card-content-title').innerText = ev.t; document.getElementById('card-content-desc').innerText = ev.d;
                    document.getElementById('card-icon').innerText = ev.i; document.getElementById('btn-card-done').classList.replace('opacity-0', 'opacity-100');
                    document.getElementById('btn-card-done').classList.remove('pointer-events-none'); document.getElementById('btn-card-done').style.transform = 'translateY(0)';
                    ev.f(); app.updateUI();
                }, 300);
            },
            openSaveModal: () => {
                document.getElementById('save-load-modal').classList.remove('hidden');
                const data = btoa(unescape(encodeURIComponent(JSON.stringify({p:player, m:market}))));
                document.getElementById('load-code-input').value = data;
                const qrCont = document.getElementById('qrcode-container'); qrCont.innerHTML = '';
                new QRCode(qrCont, { text: data, width: 192, height: 192 });
            },
            loadGame: () => {
                try {
                    const data = JSON.parse(decodeURIComponent(escape(atob(document.getElementById('load-code-input').value))));
                    player = data.p; market = data.m; app.startGame(player.color); ui.closeModal('save-load-modal');
                    alert("âœ… é€²åº¦è¼‰å…¥æˆåŠŸï¼");
                } catch(e) { alert("ä»£ç¢¼ç„¡æ•ˆ"); }
            }
        };

        const ui = { closeModal: (id) => document.getElementById(id).classList.add('hidden') };

        window.app = app; window.game = game; window.actions = actions; window.ui = ui;
    </script>
</body>
</html>